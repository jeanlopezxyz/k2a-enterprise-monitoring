# K2A Enterprise Monitoring - ArgoCD ApplicationSet
# Deploys both the monitoring stack AND kagent AI agent
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: k2a-monitoring
  namespace: openshift-gitops
  labels:
    app.kubernetes.io/name: k2a-monitoring
    app.kubernetes.io/part-of: k2a-enterprise
    app.kubernetes.io/managed-by: argocd
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]

  generators:
    - list:
        elements:
          # Development Environment
          - env: dev
            namespace: k2a-monitoring-dev
            cluster: https://kubernetes.default.svc
            clusterName: in-cluster
            revision: develop
            autoSync: true
            selfHeal: true
            prune: true

          # Staging Environment
          - env: staging
            namespace: k2a-monitoring-staging
            cluster: https://kubernetes.default.svc
            clusterName: in-cluster
            revision: release/*
            autoSync: true
            selfHeal: true
            prune: true

          # Production Environment
          - env: prod
            namespace: k2a-monitoring-prod
            cluster: https://kubernetes.default.svc
            clusterName: in-cluster
            revision: main
            autoSync: false
            selfHeal: false
            prune: false

  template:
    metadata:
      name: 'k2a-monitoring-{{ .env }}'
      namespace: openshift-gitops
      labels:
        app.kubernetes.io/name: k2a-monitoring
        app.kubernetes.io/instance: '{{ .env }}'
        app.kubernetes.io/part-of: k2a-enterprise
        app.kubernetes.io/managed-by: argocd
        environment: '{{ .env }}'
      annotations:
        argocd.argoproj.io/manifest-generate-paths: 'manifests/overlays/{{ .env }}'
        notifications.argoproj.io/subscribe.on-sync-succeeded.slack: k2a-deployments
        notifications.argoproj.io/subscribe.on-sync-failed.slack: k2a-alerts
        notifications.argoproj.io/subscribe.on-health-degraded.slack: k2a-alerts
      finalizers:
        - resources-finalizer.argocd.argoproj.io
    spec:
      project: k2a-monitoring

      source:
        repoURL: 'https://github.com/your-org/k2a-enterprise-monitoring.git'
        targetRevision: '{{ .revision }}'
        path: 'manifests/overlays/{{ .env }}'
        kustomize:
          commonLabels:
            app.kubernetes.io/instance: '{{ .env }}'
            environment: '{{ .env }}'
            deployed-by: argocd
          namespace: '{{ .namespace }}'

      destination:
        server: '{{ .cluster }}'
        namespace: '{{ .namespace }}'

      syncPolicy:
        {{- if eq .autoSync true }}
        automated:
          prune: {{ .prune }}
          selfHeal: {{ .selfHeal }}
          allowEmpty: false
        {{- end }}
        syncOptions:
          - CreateNamespace=true
          - PrunePropagationPolicy=foreground
          - PruneLast=true
          - ServerSideApply=true
          - ApplyOutOfSyncOnly=true
          - RespectIgnoreDifferences=true

        retry:
          limit: 5
          backoff:
            duration: 5s
            factor: 2
            maxDuration: 3m

        managedNamespaceMetadata:
          labels:
            app.kubernetes.io/part-of: k2a-enterprise
            environment: '{{ .env }}'
            pod-security.kubernetes.io/enforce: restricted
            pod-security.kubernetes.io/audit: restricted
            pod-security.kubernetes.io/warn: restricted

      ignoreDifferences:
        - group: apps
          kind: Deployment
          jsonPointers:
            - /spec/replicas
        - group: autoscaling
          kind: HorizontalPodAutoscaler
          jsonPointers:
            - /spec/minReplicas
            - /spec/maxReplicas
        - group: ''
          kind: Secret
          jsonPointers:
            - /data

      revisionHistoryLimit: 10

      info:
        - name: Environment
          value: '{{ .env }}'
        - name: Team
          value: Platform Engineering
        - name: Documentation
          value: https://docs.k2a.io/monitoring

---
# ApplicationSet for Kagent AI Agent
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: k2a-kagent
  namespace: openshift-gitops
  labels:
    app.kubernetes.io/name: k2a-kagent
    app.kubernetes.io/part-of: k2a-enterprise
    app.kubernetes.io/managed-by: argocd
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]

  generators:
    - list:
        elements:
          # Development
          - env: dev
            namespace: k2a-monitoring-dev
            cluster: https://kubernetes.default.svc
            revision: develop
            autoSync: true
            selfHeal: true
            prune: true
            llmProvider: anthropic
            autoRemediate: "false"
            requireApproval: "true"

          # Staging
          - env: staging
            namespace: k2a-monitoring-staging
            cluster: https://kubernetes.default.svc
            revision: release/*
            autoSync: true
            selfHeal: true
            prune: true
            llmProvider: anthropic
            autoRemediate: "true"
            requireApproval: "true"

          # Production
          - env: prod
            namespace: k2a-monitoring-prod
            cluster: https://kubernetes.default.svc
            revision: main
            autoSync: false
            selfHeal: false
            prune: false
            llmProvider: anthropic
            autoRemediate: "true"
            requireApproval: "false"  # Low-risk auto, high-risk manual

  template:
    metadata:
      name: 'k2a-kagent-{{ .env }}'
      namespace: openshift-gitops
      labels:
        app.kubernetes.io/name: k2a-kagent
        app.kubernetes.io/instance: '{{ .env }}'
        app.kubernetes.io/part-of: k2a-enterprise
        app.kubernetes.io/component: ai-agent
        environment: '{{ .env }}'
      annotations:
        argocd.argoproj.io/manifest-generate-paths: 'kagent/overlays/{{ .env }}'
        notifications.argoproj.io/subscribe.on-sync-succeeded.slack: k2a-deployments
        notifications.argoproj.io/subscribe.on-sync-failed.slack: k2a-alerts
      finalizers:
        - resources-finalizer.argocd.argoproj.io
    spec:
      project: k2a-monitoring

      source:
        repoURL: 'https://github.com/your-org/k2a-enterprise-monitoring.git'
        targetRevision: '{{ .revision }}'
        path: 'kagent/overlays/{{ .env }}'
        kustomize:
          commonLabels:
            app.kubernetes.io/instance: '{{ .env }}'
            environment: '{{ .env }}'
            deployed-by: argocd
          namespace: '{{ .namespace }}'

      destination:
        server: '{{ .cluster }}'
        namespace: '{{ .namespace }}'

      syncPolicy:
        {{- if eq .autoSync true }}
        automated:
          prune: {{ .prune }}
          selfHeal: {{ .selfHeal }}
          allowEmpty: false
        {{- end }}
        syncOptions:
          - CreateNamespace=true
          - PrunePropagationPolicy=foreground
          - ServerSideApply=true
          - ApplyOutOfSyncOnly=true

        retry:
          limit: 5
          backoff:
            duration: 5s
            factor: 2
            maxDuration: 3m

      ignoreDifferences:
        - group: apps
          kind: Deployment
          jsonPointers:
            - /spec/replicas
        - group: ''
          kind: Secret
          jsonPointers:
            - /data
        # Ignore kagent CRD status fields
        - group: kagent.dev
          kind: Agent
          jsonPointers:
            - /status
        - group: kagent.dev
          kind: ToolServer
          jsonPointers:
            - /status

      revisionHistoryLimit: 10

      info:
        - name: Environment
          value: '{{ .env }}'
        - name: Component
          value: Kagent AI Agent
        - name: LLM Provider
          value: '{{ .llmProvider }}'
        - name: Auto-Remediate
          value: '{{ .autoRemediate }}'

---
# Git Generator: Auto-discover all components
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: k2a-all-components
  namespace: openshift-gitops
  labels:
    app.kubernetes.io/name: k2a-all
    app.kubernetes.io/part-of: k2a-enterprise
spec:
  goTemplate: true

  generators:
    - matrix:
        generators:
          # Environments
          - list:
              elements:
                - env: dev
                  revision: develop
                  autoSync: true
                - env: staging
                  revision: release/*
                  autoSync: true
                - env: prod
                  revision: main
                  autoSync: false

          # Components to deploy
          - list:
              elements:
                - component: manifests
                  path: manifests/overlays
                  description: "K2A Monitoring Stack"
                - component: kagent
                  path: kagent/overlays
                  description: "Kagent AI Agent"

  template:
    metadata:
      name: 'k2a-{{ .component }}-{{ .env }}'
      namespace: openshift-gitops
      labels:
        app.kubernetes.io/name: 'k2a-{{ .component }}'
        app.kubernetes.io/instance: '{{ .env }}'
        environment: '{{ .env }}'
        component: '{{ .component }}'
    spec:
      project: k2a-monitoring
      source:
        repoURL: 'https://github.com/your-org/k2a-enterprise-monitoring.git'
        targetRevision: '{{ .revision }}'
        path: '{{ .path }}/{{ .env }}'
      destination:
        server: https://kubernetes.default.svc
        namespace: 'k2a-monitoring-{{ .env }}'
      syncPolicy:
        {{- if eq .autoSync true }}
        automated:
          prune: true
          selfHeal: true
        {{- end }}
        syncOptions:
          - CreateNamespace=true
          - ServerSideApply=true

      info:
        - name: Component
          value: '{{ .description }}'
        - name: Environment
          value: '{{ .env }}'
