# =============================================================================
# K2A Production Values
# =============================================================================
#
# Este archivo contiene la configuracion de produccion para:
#   - MCP Servers (Quarkus Native: Prometheus, AlertManager, Red Hat Cases, Sessionize)
#   - K2A Agent (Agente de IA)
#
# ARQUITECTURA:
#   - Namespace 'k2a': Toda la aplicacion (Agent + MCP Servers)
#   - Namespace 'kagent': Solo el operador kagent (controller, ui, tools)
#
# PREREQUISITO: Crear los secrets antes de desplegar
#   kubectl create namespace k2a
#   kubectl create secret generic kagent-openai \
#     --namespace k2a \
#     --from-literal=OPENAI_API_KEY="sk-..."
#
# =============================================================================

# =============================================================================
# SECCION 1: MCP SERVERS (chart: kmcp-servers) - Quarkus Native
# =============================================================================

# Namespace unificado para toda la aplicacion K2A
global:
  namespace: k2a

# =============================================================================
# RBAC Configuration for OpenShift Monitoring Access
# =============================================================================
# The built-in cluster-monitoring-view ClusterRole doesn't include alertmanagers/api
# We create a custom ClusterRole with proper permissions for both Prometheus and AlertManager
rbac:
  create: true
  serviceAccount:
    name: kmcp-servers
    annotations: {}
  # Custom ClusterRole for OpenShift Monitoring API access
  # Creates: ClusterRole k2a-monitoring-api-access + ClusterRoleBinding
  monitoringApiAccess:
    create: true
  # Optional: Additional binding to cluster-monitoring-view (disabled by default)
  clusterRoleBinding:
    create: false
    clusterRole: cluster-monitoring-view

servers:
  # ------------------------------------------
  # Prometheus MCP Server (Quarkus Native)
  # ------------------------------------------
  # NOTA: Usando HTTP transport directo (sin Transport Adapter)
  # Quarkus expone HTTP/SSE nativo en /mcp endpoint
  prometheus:
    enabled: true
    name: prometheus-mcp
    description: "MCP Server para consultas PromQL a Prometheus/Thanos (Quarkus Native)"
    transportType: http
    image:
      repository: ghcr.io/jeanlopezxyz/mcp-prometheus
      tag: "1.0.8"
    port: 9081  # Puerto HTTP nativo de Quarkus
    httpTransport:
      targetPort: 9081
      path: /mcp  # Streamable HTTP endpoint
    env:
      PROMETHEUS_URL: "https://thanos-querier.openshift-monitoring.svc.cluster.local:9091"
      # HTTP mode - stdio disabled
      QUARKUS_MCP_SERVER_STDIO_ENABLED: "false"
      QUARKUS_HTTP_PORT: "9081"
      QUARKUS_HTTP_HOST: "0.0.0.0"
      # Trust OpenShift internal SSL certificates
      QUARKUS_TLS_TRUST_ALL: "true"
      # Session timeout (5 minutes) to prevent premature session termination
      QUARKUS_MCP_SERVER_HTTP_SESSION_TIMEOUT: "300"
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 500m
        memory: 256Mi

  # ------------------------------------------
  # AlertManager MCP Server (Quarkus Native)
  # ------------------------------------------
  # NOTA: Usando HTTP transport directo (sin Transport Adapter)
  # Quarkus expone HTTP/SSE nativo en /mcp endpoint
  alertmanager:
    enabled: true
    name: alertmanager-mcp
    description: "MCP Server para AlertManager (Quarkus Native)"
    transportType: http
    image:
      repository: ghcr.io/jeanlopezxyz/mcp-alertmanager
      tag: "1.0.13"
    port: 9082  # Puerto HTTP nativo de Quarkus
    httpTransport:
      targetPort: 9082
      path: /mcp  # Streamable HTTP endpoint
    env:
      ALERTMANAGER_URL: "https://alertmanager-main.openshift-monitoring.svc.cluster.local:9094"
      # HTTP mode - stdio disabled
      QUARKUS_MCP_SERVER_STDIO_ENABLED: "false"
      QUARKUS_HTTP_PORT: "9082"
      QUARKUS_HTTP_HOST: "0.0.0.0"
      # Trust OpenShift internal SSL certificates
      QUARKUS_TLS_TRUST_ALL: "true"
      # Session timeout (5 minutes) to prevent premature session termination
      QUARKUS_MCP_SERVER_HTTP_SESSION_TIMEOUT: "300"
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 500m
        memory: 256Mi

  # ------------------------------------------
  # Red Hat Cases MCP Server (Quarkus Native)
  # ------------------------------------------
  # NOTA: Usando HTTP transport directo (sin Transport Adapter)
  # Quarkus expone HTTP/SSE nativo en /mcp endpoint
  redhatCases:
    enabled: true
    name: redhat-cases-mcp
    description: "MCP Server para Red Hat KB y casos de soporte (Quarkus Native)"
    transportType: http
    image:
      repository: ghcr.io/jeanlopezxyz/mcp-redhat-cases
      tag: "latest"
    port: 9083  # Puerto HTTP nativo de Quarkus
    httpTransport:
      targetPort: 9083
      path: /mcp  # Streamable HTTP endpoint
    env:
      # HTTP mode - stdio disabled
      QUARKUS_MCP_SERVER_STDIO_ENABLED: "false"
      QUARKUS_HTTP_PORT: "9083"
      QUARKUS_HTTP_HOST: "0.0.0.0"
      # Session timeout (5 minutes) to prevent premature session termination
      QUARKUS_MCP_SERVER_HTTP_SESSION_TIMEOUT: "300"
    secretRefs:
      - redhat-cases-mcp-secrets
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 500m
        memory: 256Mi

  # ------------------------------------------
  # Sessionize MCP Server (Quarkus Native)
  # ------------------------------------------
  # NOTA: Usando HTTP transport directo (sin Transport Adapter)
  # Quarkus expone HTTP/SSE nativo en /mcp endpoint
  sessionize:
    enabled: true
    name: sessionize-mcp
    description: "MCP Server para Sessionize - conferencias y eventos (Quarkus Native)"
    transportType: http
    image:
      repository: ghcr.io/jeanlopezxyz/mcp-sessionize
      tag: "1.0.2"
    port: 9084  # Puerto HTTP nativo de Quarkus
    httpTransport:
      targetPort: 9084
      path: /mcp  # Streamable HTTP endpoint
    env:
      # HTTP mode - stdio disabled
      QUARKUS_MCP_SERVER_STDIO_ENABLED: "false"
      QUARKUS_HTTP_PORT: "9084"
      QUARKUS_HTTP_HOST: "0.0.0.0"
      # Session timeout (5 minutes) to prevent premature session termination
      QUARKUS_MCP_SERVER_HTTP_SESSION_TIMEOUT: "300"
      # SESSIONIZE_EVENT_ID: ""  # Configurar via secret o tool parameter
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 500m
        memory: 256Mi

  # ------------------------------------------
  # Kubernetes MCP Server (Go Native)
  # ------------------------------------------
  # NOTA: Usando HTTP transport directo
  # Go nativo expone HTTP en /mcp endpoint con /healthz health check
  kubernetes:
    enabled: true
    name: kubernetes-mcp
    description: "MCP Server para gestion de Kubernetes/OpenShift (Go Native)"
    transportType: http
    image:
      repository: quay.io/containers/kubernetes_mcp_server
      tag: "latest"
    port: 8080  # Puerto HTTP nativo de Go
    httpTransport:
      targetPort: 8080
      path: /mcp
    env:
      # Enable OpenShift specific features
      OPENSHIFT: "true"
    # ServiceAccount needs cluster-admin or appropriate RBAC
    serviceAccount:
      create: true
      name: kubernetes-mcp
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 256Mi
    # Custom health check path for Go server
    livenessProbe:
      httpGet:
        path: /healthz
        port: 8080
      initialDelaySeconds: 10
      periodSeconds: 30
    readinessProbe:
      httpGet:
        path: /healthz
        port: 8080
      initialDelaySeconds: 5
      periodSeconds: 10

# =============================================================================
# SECCION 2: K2A AGENT (chart: kagent-app)
# =============================================================================

# ModelConfig - Configuracion del modelo LLM principal
# gpt-4o-mini: 15x m치s econ칩mico que gpt-4o, r치pido, 128K contexto
modelConfig:
  create: true
  name: k2a-openai-config
  provider: OpenAI
  model: gpt-4o-mini
  secretRef:
    name: kagent-openai
    key: OPENAI_API_KEY

# Modelos adicionales
additionalModelConfigs:
  # DeepSeek - Modelo econ칩mico y potente
  # deepseek-chat: Modelo general (DeepSeek-V3.2)
  # deepseek-reasoner: Razonamiento avanzado con chain-of-thought
  deepseek:
    create: true
    name: k2a-deepseek-config
    provider: OpenAI  # DeepSeek usa API compatible con OpenAI
    model: deepseek-chat
    secretRef:
      name: kagent-deepseek
      key: DEEPSEEK_API_KEY
    openAI:
      baseUrl: "https://api.deepseek.com"
      temperature: "0.7"
      maxTokens: 4096

# Agent configuration
agent:
  name: k2a-enterprise-monitoring
  namespace: k2a  # Mismo namespace que MCP servers para usar MCPServer (kmcp)
  modelConfig: k2a-openai-config  # Opciones: k2a-openai-config, k2a-deepseek-config
  # Memory for RAG with Pinecone (reduces token usage)
  # NOTE: Memory only works with v1alpha1 Agent, but kagent has a bug with v1alpha1 conversion
  # Disabled until kagent fixes the v1alpha1 -> v1alpha2 conversion
  memory:
    enabled: false
    name: k2a-memory
  # Use ConfigMap for systemMessage (scalable option)
  systemMessageConfigMap:
    enabled: true
    create: true
    name: k2a-system-prompt
    key: system-prompt
  systemMessage: |
    You are K2A, an AI agent for Kubernetes enterprise monitoring.

    Available Tools (16 total):

    ALERTMANAGER:
    - getAlerts: Get current firing/silenced alerts
    - getAlertGroups: Alerts organized by routing groups
    - getAlertmanagerStatus: Check AlertManager health

    PROMETHEUS:
    - query: Execute instant PromQL query
    - queryRange: Execute range query for time series
    - getPrometheusStatus: Check Prometheus health

    KUBERNETES (read-only):
    - pods_list: List pods in namespace
    - pods_get: Get pod details
    - pods_log: Get pod logs
    - resources_list: List any Kubernetes resources
    - resources_get: Get resource details
    - events_list: List cluster events
    - helm_list: List Helm releases

    RED HAT SUPPORT:
    - searchKnowledgeBase: Search Red Hat KB articles
    - getSolution: Get full KB article content
    - searchCases: List and filter cases

    Tool Selection:
    - ALERTS: getAlerts, getAlertGroups
    - METRICS: query, queryRange
    - K8S RESOURCES: pods_list, resources_list, resources_get
    - TROUBLESHOOTING: pods_log, events_list
    - RED HAT KB: searchKnowledgeBase, getSolution

  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 1000m
      memory: 1Gi

# MCPServer references (kmcp) - Agent y MCP servers en mismo namespace
# El Agent referencia directamente los MCPServer CRDs de kmcp (sin URLs)
# Esto es posible porque todo esta en namespace 'k2a'
#
# OPTIMIZADO: Reducido de 42 a 16 tools para evitar exceder limite de contexto (128k tokens)
mcpServers:
  prometheus:
    enabled: true
    name: prometheus-mcp
    tools:
      - query           # Consultas PromQL instantaneas
      - queryRange      # Consultas de series de tiempo
      - getPrometheusStatus  # Verificar salud

  alertmanager:
    enabled: true
    name: alertmanager-mcp
    tools:
      - getAlerts       # Ver alertas activas
      - getAlertGroups  # Alertas agrupadas
      - getAlertmanagerStatus  # Verificar salud

  redhatCases:
    enabled: true
    name: redhat-cases-mcp
    tools:
      - searchKnowledgeBase  # Buscar articulos KB
      - getSolution          # Obtener contenido de KB
      - searchCases          # Buscar casos existentes

  sessionize:
    enabled: false  # Deshabilitado - no esencial
    name: sessionize-mcp
    tools:
      - getSpeakers
      - getSessions

  kubernetes:
    enabled: true
    name: kubernetes-mcp
    tools:
      # Solo lectura - esencial para troubleshooting
      - pods_list       # Listar pods
      - pods_get        # Detalles de pod
      - pods_log        # Logs de pod (troubleshooting)
      - resources_list  # Listar recursos
      - resources_get   # Detalles de recurso
      - events_list     # Eventos del cluster
      - helm_list       # Listar releases Helm

# A2A Skills
a2aSkills:
  - id: alert-monitoring
    name: Alert Monitoring
    description: Monitor and analyze alerts from Prometheus and AlertManager
    examples:
      - What alerts are currently firing?
      - Show me critical alerts
    tags:
      - alerts
      - monitoring
    inputModes:
      - text
    outputModes:
      - text

  - id: metrics-analysis
    name: Metrics Analysis
    description: Query and analyze Prometheus metrics
    examples:
      - What is the CPU usage?
      - Show memory usage
    tags:
      - metrics
      - prometheus
    inputModes:
      - text
    outputModes:
      - text

  - id: redhat-support
    name: Red Hat Support
    description: Search Red Hat KB and manage support cases
    examples:
      - Search for OOMKilled errors
      - Find solutions for pod crashes
    tags:
      - redhat
      - kb
      - support
    inputModes:
      - text
    outputModes:
      - text

  - id: kubernetes-management
    name: Kubernetes Management
    description: Manage Kubernetes/OpenShift cluster resources, pods, deployments, and Helm releases
    examples:
      - List pods in namespace default
      - Get logs from pod nginx
      - Show deployment status
      - List Helm releases
    tags:
      - kubernetes
      - openshift
      - pods
      - helm
    inputModes:
      - text
    outputModes:
      - text

# =============================================================================
# SECCION 3: CONFIGURACION COMPARTIDA
# =============================================================================

networkPolicy:
  enabled: false  # Disabled - was blocking traffic from kagent namespace

monitoring:
  serviceMonitor:
    enabled: false
  prometheusRule:
    enabled: true

autoscaling:
  enabled: false

podDisruptionBudget:
  enabled: false

# =============================================================================
# SECCION 4: TRACING - JAEGER INSTANCE
# =============================================================================
# Despliega instancia de Jaeger usando el operador Red Hat OpenShift distributed tracing
# El operador ya esta instalado (jaeger-operator.v1.65.0-1)
#
# Endpoint para kagent: http://jaeger-collector.k2a.svc.cluster.local:4317
#
tracing:
  enabled: true
  name: jaeger
  namespace: k2a  # Mismo namespace que la app ArgoCD
  strategy: allInOne
  # Usar imagen latest ya que 1.65.0 no existe en registry.redhat.io
  image: registry.redhat.io/rhosdt/jaeger-all-in-one-rhel8:latest
  logLevel: info
  storage:
    type: memory
    maxTraces: 100000
  ingress:
    enabled: true  # Habilitar ruta para acceder a Jaeger UI
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
